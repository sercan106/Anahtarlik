{% extends "ana.html" %}
{% load static %}
{% load l10n %}

{% block title %}{{ hayvan.ad }} - KÃ¼nye Bilgisi{% endblock %}

{% block css_dosyalar %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<style>
    :root {
        --primary-color: #5B9BD5;
        --secondary-color: #70C1B3;
        --accent-color: #FF8C42;
        --success-color: #6FCF97;
        --danger-color: #EB5757;
        --warning-color: #F2C94C;
        --bg-color: linear-gradient(135deg, #f0f7ff 0%, #e8f4f8 50%, #f5f0ff 100%);
        --card-bg: rgba(255, 255, 255, 0.95);
        --primary-gradient: linear-gradient(135deg, #5B9BD5 0%, #70C1B3 100%);
        --shadow-soft: 0 10px 40px rgba(91, 155, 213, 0.12);
        --shadow-hover: 0 20px 60px rgba(91, 155, 213, 0.18);
    }

    body {
        background: var(--bg-color) !important;
        font-family: 'Inter', sans-serif;
        padding-bottom: 100px; /* Sticky footer payÄ± */
    }

    /* Modern Kart TasarÄ±mÄ± (Glassmorphism) */
    .modern-card {
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(91, 155, 213, 0.1);
        border-radius: 24px;
        box-shadow: var(--shadow-soft);
        overflow: hidden;
        margin-bottom: 24px;
        transition: all 0.3s ease;
    }
    
    .modern-card:hover {
        box-shadow: var(--shadow-hover);
    }

    /* KayÄ±p Modu Animasyonu */
    .emergency-mode {
        border: 2px solid var(--danger-color);
        animation: pulse-red 2s infinite;
    }

    @keyframes pulse-red {
        0% { box-shadow: 0 0 0 0 rgba(235, 87, 87, 0.4); }
        70% { box-shadow: 0 0 0 20px rgba(235, 87, 87, 0); }
        100% { box-shadow: 0 0 0 0 rgba(235, 87, 87, 0); }
    }

    /* Profil Resmi */
    .profile-image-container {
        width: 140px;
        height: 140px;
        margin: -70px auto 20px;
        border-radius: 50%;
        border: 6px solid white;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        background: white;
        position: relative;
        z-index: 10;
    }
    
    .profile-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* BaÅŸlÄ±k KartÄ± ArkaplanÄ± */
    .header-bg {
        height: 160px;
        background: var(--primary-gradient);
        border-radius: 24px 24px 0 0;
    }
    .header-bg.lost {
        background: linear-gradient(135deg, var(--danger-color) 0%, #ff6b6b 100%);
    }

    /* Bilgi KutucuklarÄ± */
    .info-pill {
        background: #F9FAFB;
        border-radius: 16px;
        padding: 12px;
        text-align: center;
        border: 1px solid #E5E7EB;
    }
    .info-label { font-size: 0.75rem; color: #6B7280; text-transform: uppercase; letter-spacing: 0.5px; }
    .info-value { font-weight: 700; color: #1F2937; font-size: 1rem; }

    /* Harita */
    #map-container {
        height: 250px;
        width: 100%;
        border-radius: 16px;
        z-index: 1;
        margin-top: 15px;
    }

    /* Sticky Footer */
    .sticky-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(12px);
        padding: 16px 24px;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        z-index: 1000;
        border-top: 1px solid rgba(0,0,0,0.05);
    }

    .btn-xl {
        padding: 16px 24px;
        font-size: 1.1rem;
        font-weight: 700;
        border-radius: 16px;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: transform 0.1s;
    }
    .btn-xl:active { transform: scale(0.98); }

    .btn-whatsapp { 
        background: linear-gradient(135deg, #25D366 0%, #1ebc57 100%); 
        color: white; 
        border: none; 
        box-shadow: 0 6px 20px rgba(37, 211, 102, 0.35);
    }
    .btn-phone { 
        background: var(--primary-gradient); 
        color: white; 
        border: none; 
        box-shadow: 0 6px 20px rgba(91, 155, 213, 0.35);
    }
    .btn-whatsapp:hover { 
        box-shadow: 0 10px 30px rgba(37, 211, 102, 0.45); 
        color: white; 
        transform: translateY(-2px);
    }
    .btn-phone:hover { 
        box-shadow: 0 10px 30px rgba(91, 155, 213, 0.45); 
        color: white; 
        transform: translateY(-2px);
    }
    
    @media (prefers-reduced-motion: reduce) {
        .btn-xl,
        .modern-card {
            transition: none;
        }
        
        .btn-whatsapp:hover,
        .btn-phone:hover {
            transform: none;
        }
        
        .emergency-mode {
            animation: none;
        }
    }

</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-6 col-md-8">

            <div class="modern-card {% if hayvan.kayip_durumu %}emergency-mode{% endif %}">
                <div class="header-bg {% if hayvan.kayip_durumu %}lost{% endif %}"></div>
                
                <div class="profile-image-container">
                    {% if hayvan.resim %}
                        <img src="{{ hayvan.resim.url }}" class="profile-image" alt="{{ hayvan.ad }}">
                    {% else %}
                        <div class="d-flex align-items-center justify-content-center h-100 bg-light text-secondary">
                            <i class="fas fa-paw fa-4x"></i>
                        </div>
                    {% endif %}
                </div>

                <div class="text-center px-4 pb-4">
                    {% if hayvan.kayip_durumu %}
                        <div class="badge bg-danger px-3 py-2 rounded-pill mb-2 animate-pulse">ğŸš¨ KAYIP ARANIYOR</div>
                        {% endif %}

                    <h1 class="fw-bolder mb-1">{{ hayvan.ad }}</h1>
                    <p class="text-muted mb-3">
                        <i class="fas fa-fingerprint me-1"></i> ID: {{ etiket.seri_numarasi }}
                    </p>

                    <div class="row g-2 mb-4">
                        <div class="col-6">
                            <div class="info-pill">
                                <div class="info-label">TÃ¼r</div>
                                <div class="info-value">{{ hayvan.tur.ad }}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="info-pill">
                                <div class="info-label">Cinsiyet</div>
                                <div class="info-value">{{ hayvan.get_cinsiyet_display }}</div>
                            </div>
                                </div>
                                <div class="col-6">
                            <div class="info-pill">
                                <div class="info-label">Irk</div>
                                <div class="info-value">{{ hayvan.irk.ad }}</div>
                            </div>
                        </div>
                        <div class="col-6">
                                <div class="info-pill">
                                <div class="info-label">YaÅŸ</div>
                                <div class="info-value">{{ hayvan.yas_hesapla }}</div>
                            </div>
                                </div>
                            </div>

                    {% if hayvan.saglik_notu %}
                    <div class="alert alert-warning text-start border-0 shadow-sm rounded-4">
                        <div class="d-flex">
                            <div class="me-3"><i class="fas fa-notes-medical fa-2x text-warning"></i></div>
                            <div>
                                <h6 class="fw-bold mb-1">SaÄŸlÄ±k Notu</h6>
                                <small>{{ hayvan.saglik_notu }}</small>
                            </div>
                        </div>
                                </div>
                            {% endif %}
                </div>
            </div>

            {% if etiket.aktif or hayvan.kayip_durumu %}
            <div class="modern-card p-4">
                <h5 class="fw-bold mb-4 border-bottom pb-2">
                    <i class="fas fa-user-shield me-2 text-primary"></i>Sahip Bilgileri
                </h5>
                
                <div class="d-flex align-items-center mb-4">
                    <div class="bg-light rounded-circle p-3 me-3">
                        <i class="fas fa-user fa-2x text-secondary"></i>
                    </div>
                                <div>
                        <h4 class="fw-bold mb-0">
                            {% if hayvan.sahip.ad or hayvan.sahip.soyad %}
                                {{ hayvan.sahip.ad|default:"" }} {{ hayvan.sahip.soyad|default:"" }}
                            {% else %}
                                KayÄ±tlÄ± Sahip
                            {% endif %}
                        </h4>
                        <p class="text-muted mb-0">KayÄ±tlÄ± Sahibi</p>
                    </div>
                </div>

                <div id="location-status-box" style="display:none;" class="mb-3">
                    <div id="location-alert" class="alert py-2 px-3 rounded-3 d-flex align-items-center">
                        <i class="fas fa-check-circle me-2"></i>
                        <small id="location-message">Konumunuz tespit edildi ve sahibe iletildi.</small>
                    </div>
                    <div id="location-warning" style="display:none;" class="alert alert-warning py-2 px-3 rounded-3 mb-2">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <small id="location-warning-text"></small>
                    </div>
                    <div id="map-container"></div>
                    <div class="mt-2 text-center">
                        <button type="button" id="manual-location-btn" class="btn btn-sm btn-outline-secondary" style="display:none;">
                            <i class="fas fa-map-marker-alt me-1"></i>Manuel Konum Gir
                        </button>
                    </div>
                </div>

                <div id="gps-loading-box" style="display:none;" class="mb-3">
                    <div class="alert alert-info py-2 px-3 rounded-3 d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status">
                            <span class="visually-hidden">YÃ¼kleniyor...</span>
                        </div>
                        <small>Konumunuz alÄ±nÄ±yor...</small>
                    </div>
                </div>

                <div id="gps-error-box" style="display:none;" class="mb-3">
                    <div class="alert alert-warning py-2 px-3 rounded-3 d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <small id="gps-error-message">Konum alÄ±namadÄ±. LÃ¼tfen tarayÄ±cÄ± ayarlarÄ±nÄ±zdan konum iznini aÃ§Ä±n.</small>
                    </div>
                </div>

                <p class="text-muted small text-center">
                    <i class="fas fa-info-circle me-1"></i>
                    AÅŸaÄŸÄ±daki butonlarÄ± kullanarak hÄ±zlÄ±ca konum gÃ¶nderebilirsiniz.
                </p>
            </div>
            {% else %}
            <div class="alert alert-secondary text-center py-4 rounded-4">
                <h4>Hizmet DÄ±ÅŸÄ±</h4>
                <p>Bu etiket ÅŸu an aktif deÄŸil.</p>
            </div>
            {% endif %}

            <div class="modern-card p-4">
                <h5 class="fw-bold mb-3">
                    <i class="fas fa-envelope-open-text me-2 text-primary"></i>Mesaj BÄ±rakÄ±n
                </h5>
                <p class="text-muted small mb-3">Telefonla ulaÅŸamadÄ±ysanÄ±z buradan mesaj bÄ±rakabilirsiniz.</p>
                
                <form id="bulan-bilgi-form" method="POST" action="">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="bulan_bilgisi">
                    {% if tarama_id %}
                    <input type="hidden" name="tarama_id" value="{{ tarama_id }}">
                    {% endif %}
                    
                    <div class="mb-3">
                        <input type="text" class="form-control form-control-lg bg-light border-0" name="bulan_isim" placeholder="AdÄ±nÄ±z" required maxlength="100">
                    </div>
                    <div class="mb-3">
                        <input type="tel" class="form-control form-control-lg bg-light border-0" name="bulan_telefon" placeholder="Telefon NumaranÄ±z (05XX XXX XX XX)" required pattern="(\+90|0)?[5][0-9]{9}" maxlength="15">
                        <small class="text-muted">Ã–rn: 0532 123 45 67</small>
                    </div>
                    <div class="mb-3">
                        <input type="email" class="form-control form-control-lg bg-light border-0" name="bulan_email" placeholder="E-posta Adresiniz (Opsiyonel)" maxlength="254">
                    </div>
                    <div class="mb-3">
                        <textarea class="form-control form-control-lg bg-light border-0" name="bulan_mesaj" rows="3" placeholder="MesajÄ±nÄ±z (Ã–rn: Kedinizi marketin Ã¶nÃ¼nde gÃ¶rdÃ¼m)" required maxlength="1000"></textarea>
                    </div>
                    
                    <div id="form-loading" style="display:none;" class="mb-3">
                        <div class="alert alert-info py-2 px-3 rounded-3 text-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status">
                                <span class="visually-hidden">GÃ¶nderiliyor...</span>
                            </div>
                            <small>MesajÄ±nÄ±z gÃ¶nderiliyor...</small>
                        </div>
                    </div>
                    
                    <div id="form-success" style="display:none;" class="mb-3">
                        <div class="alert alert-success py-2 px-3 rounded-3">
                            <i class="fas fa-check-circle me-2"></i>
                            <small>MesajÄ±nÄ±z baÅŸarÄ±yla gÃ¶nderildi! Hayvan sahibi en kÄ±sa sÃ¼rede sizinle iletiÅŸime geÃ§ecektir.</small>
                        </div>
                    </div>
                    
                    <div id="form-error" style="display:none;" class="mb-3">
                        <div class="alert alert-danger py-2 px-3 rounded-3">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <small id="form-error-message">Bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.</small>
                        </div>
                    </div>
                    
                    <button type="submit" id="submit-btn" class="btn btn-dark w-100 py-3 rounded-3 fw-bold">
                        <i class="fas fa-paper-plane me-2"></i>MesajÄ± GÃ¶nder
                    </button>
                </form>
            </div>

        </div>
    </div>
</div>

{% if etiket.aktif or hayvan.kayip_durumu %}
<div class="sticky-footer">
    <div class="row g-2">
        {% if hayvan.sahip.telefon %}
        <div class="col-6">
            <a href="tel:{{ hayvan.sahip.telefon }}" class="btn btn-xl btn-phone contact-trigger">
                <i class="fas fa-phone-alt"></i> Ara
            </a>
        </div>
        {% else %}
        <div class="col-6">
            <button class="btn btn-xl btn-phone" disabled title="Telefon numarasÄ± bulunamadÄ±">
                <i class="fas fa-phone-alt"></i> Ara
            </button>
        </div>
        {% endif %}
        <div class="{% if hayvan.sahip.telefon %}col-6{% else %}col-12{% endif %}">
            <a href="#" id="whatsapp-link" target="_blank" class="btn btn-xl btn-whatsapp contact-trigger">
                <i class="fab fa-whatsapp"></i> Mesaj
            </a>
        </div>
    </div>
</div>
{% endif %}

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // DeÄŸiÅŸkenler
    const whatsappLink = document.getElementById('whatsapp-link');
    const mapContainer = document.getElementById('map-container');
    const locationStatusBox = document.getElementById('location-status-box');
    const gpsLoadingBox = document.getElementById('gps-loading-box');
    const gpsErrorBox = document.getElementById('gps-error-box');
    const gpsErrorMessage = document.getElementById('gps-error-message');
    
    // Django'dan gelen veriler (GÃ¼venli Veri AktarÄ±mÄ±)
    const phoneRaw = '{{ hayvan.sahip.telefon|default:"" }}';
    const phoneClean = phoneRaw ? phoneRaw.replace(/\D/g, '') : ''; // Sadece rakamlar
    const petName = '{{ hayvan.ad }}';
    const taramaId = '{{ tarama_id|default:"" }}';
    
    // tarama_id kontrolÃ¼
    if (!taramaId) {
        console.warn("âš ï¸ tarama_id bulunamadÄ±, GPS gÃ¼ncelleme yapÄ±lamayacak");
    }
    
    // Telefon kontrolÃ¼
    if (!phoneClean) {
        console.warn("âš ï¸ Telefon numarasÄ± bulunamadÄ±, WhatsApp linki oluÅŸturulamayacak");
        if (whatsappLink) {
            whatsappLink.href = '#';
            whatsappLink.onclick = function(e) {
                e.preventDefault();
                alert('Telefon numarasÄ± bulunamadÄ±. LÃ¼tfen mesaj formunu kullanÄ±n.');
            };
        }
    }
    
    // BaÅŸlangÄ±Ã§ mesajÄ± (Konumsuz)
    let currentMessage = `Merhaba, ${petName} isimli evcil hayvanÄ±nÄ±zÄ± buldum. LÃ¼tfen bana ulaÅŸÄ±n.`;
    if (phoneClean) {
        updateWhatsappUrl(currentMessage);
    }

    let map = null;
    let gpsSent = false; // GPS gÃ¶nderildi mi kontrolÃ¼

    // 1. Konum Ä°steÄŸi BaÅŸlat
    if (navigator.geolocation) {
        gpsLoadingBox.style.display = 'block';
        navigator.geolocation.getCurrentPosition(onSuccess, onError, {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 0
        });
    } else {
        showGpsError('Bu tarayÄ±cÄ± konum servisini desteklemiyor.');
    }

    // 2. Konum BaÅŸarÄ±lÄ±ysa
    function onSuccess(position) {
        gpsLoadingBox.style.display = 'none';
        gpsErrorBox.style.display = 'none';
        
        // KoordinatlarÄ± Number'a Ã§evir ve validasyon
        const lat = Number(position.coords.latitude);
        const lng = Number(position.coords.longitude);
        const acc = Number(position.coords.accuracy);

        // GPS koordinat validasyonu
        if (isNaN(lat) || isNaN(lng) || isNaN(acc)) {
            showGpsError('GeÃ§ersiz konum verisi alÄ±ndÄ±.');
            return;
        }

        if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
            showGpsError('GeÃ§ersiz koordinat aralÄ±ÄŸÄ±.');
            return;
        }

        console.log("âœ… Konum Bulundu:", lat, lng, "DoÄŸruluk: Â±" + Math.round(acc) + "m");

        // Accuracy kontrolÃ¼ ve uyarÄ± mesajlarÄ±
        const locationAlert = document.getElementById('location-alert');
        const locationMessage = document.getElementById('location-message');
        const locationWarning = document.getElementById('location-warning');
        const locationWarningText = document.getElementById('location-warning-text');
        const manualLocationBtn = document.getElementById('manual-location-btn');
        
        // Accuracy'ye gÃ¶re uyarÄ± seviyesi belirle
        let alertClass = 'alert-success';
        let warningMessage = '';
        let showManualBtn = false;
        
        if (acc >= 5000) {
            // Ã‡ok yanlÄ±ÅŸ konum (IP/Wi-Fi tabanlÄ±)
            alertClass = 'alert-danger';
            warningMessage = 'âš ï¸ Bu konum Ã§ok yanlÄ±ÅŸ olabilir! PC\'lerde GPS olmadÄ±ÄŸÄ± iÃ§in IP tabanlÄ± tahmini konum kullanÄ±lÄ±yor. LÃ¼tfen manuel olarak doÄŸru konumunuzu girin.';
            showManualBtn = true;
            locationMessage.textContent = 'Konum tespit edildi ancak doÄŸruluÄŸu dÃ¼ÅŸÃ¼k (Â±' + Math.round(acc/1000) + 'km).';
        } else if (acc >= 1000) {
            // Orta seviye yanlÄ±ÅŸlÄ±k
            alertClass = 'alert-warning';
            warningMessage = 'âš ï¸ Bu konum tahmini bir konumdur (IP/Wi-Fi tabanlÄ±). DoÄŸruluÄŸu dÃ¼ÅŸÃ¼k olabilir (Â±' + Math.round(acc) + 'm). MÃ¼mkÃ¼nse cep telefonunuzdan konum paylaÅŸÄ±n.';
            showManualBtn = true;
            locationMessage.textContent = 'Konum tespit edildi ve sahibe iletildi.';
        } else if (acc >= 100) {
            // Kabul edilebilir ama ideal deÄŸil
            alertClass = 'alert-info';
            locationMessage.textContent = 'Konumunuz tespit edildi ve sahibe iletildi. (DoÄŸruluk: Â±' + Math.round(acc) + 'm)';
        } else {
            // Ä°yi doÄŸruluk
            locationMessage.textContent = 'Konumunuz tespit edildi ve sahibe iletildi. (DoÄŸruluk: Â±' + Math.round(acc) + 'm)';
        }
        
        // Alert class'Ä±nÄ± gÃ¼ncelle
        locationAlert.className = 'alert ' + alertClass + ' py-2 px-3 rounded-3 d-flex align-items-center';
        
        // UyarÄ± mesajÄ±nÄ± gÃ¶ster/gizle
        if (warningMessage) {
            locationWarningText.textContent = warningMessage;
            locationWarning.style.display = 'block';
        } else {
            locationWarning.style.display = 'none';
        }
        
        // Manuel konum butonunu gÃ¶ster/gizle
        if (showManualBtn) {
            manualLocationBtn.style.display = 'inline-block';
        } else {
            manualLocationBtn.style.display = 'none';
        }

        // A. HaritayÄ± GÃ¶ster
        locationStatusBox.style.display = 'block';
        initMap(lat, lng);

        // B. WhatsApp Linkini Konumla GÃ¼ncelle
        if (phoneClean) {
            const mapsLink = `https://www.google.com/maps?q=${lat},${lng}`;
            let locationMsg = `Merhaba, ${petName} isimli evcil hayvanÄ±nÄ±zÄ± buldum.\n\nğŸ“ Åu anki konumum:\n${mapsLink}`;
            
            // Accuracy uyarÄ±sÄ± ekle
            if (acc >= 5000) {
                locationMsg += `\n\nâš ï¸ UYARI: Bu konum tahmini bir konumdur (IP tabanlÄ±). DoÄŸruluÄŸu dÃ¼ÅŸÃ¼k olabilir (Â±${Math.round(acc/1000)}km).`;
            } else if (acc >= 1000) {
                locationMsg += `\n\nâš ï¸ NOT: Bu konum tahmini bir konumdur. DoÄŸruluÄŸu dÃ¼ÅŸÃ¼k olabilir (Â±${Math.round(acc)}m).`;
            } else {
                locationMsg += `\n\n(DoÄŸruluk: Â±${Math.round(acc)}m)`;
            }
            
            updateWhatsappUrl(locationMsg);
        }

        // C. Sunucuya Kaydet (tarama_id varsa)
        // Sadece accuracy < 5000m ise otomatik gÃ¶nder (Ã§ok yanlÄ±ÅŸ konumlarÄ± gÃ¶nderme)
        if (taramaId && acc < 5000) {
            saveToServer(lat, lng, acc);
        } else if (taramaId && acc >= 5000) {
            console.warn("âš ï¸ Accuracy Ã§ok dÃ¼ÅŸÃ¼k (" + acc + "m), otomatik gÃ¶nderilmedi. KullanÄ±cÄ± manuel gÃ¶nderebilir.");
            // KullanÄ±cÄ±ya bilgi ver
            locationMessage.textContent += ' (Otomatik gÃ¶nderilmedi - doÄŸruluÄŸu dÃ¼ÅŸÃ¼k)';
        } else {
            console.warn("âš ï¸ tarama_id yok, GPS sunucuya gÃ¶nderilemedi");
        }
    }

    function onError(error) {
        gpsLoadingBox.style.display = 'none';
        
        let errorMsg = 'Konum alÄ±namadÄ±.';
                if (error.code === error.PERMISSION_DENIED) {
            errorMsg = 'Konum izni verilmedi. LÃ¼tfen tarayÄ±cÄ± ayarlarÄ±nÄ±zdan konum iznini aÃ§Ä±n.';
        } else if (error.code === error.POSITION_UNAVAILABLE) {
            errorMsg = 'Konum bilgisi alÄ±namadÄ±. LÃ¼tfen GPS\'inizin aÃ§Ä±k olduÄŸundan emin olun.';
        } else if (error.code === error.TIMEOUT) {
            errorMsg = 'Konum alma zaman aÅŸÄ±mÄ±na uÄŸradÄ±. LÃ¼tfen tekrar deneyin.';
        }
        
        showGpsError(errorMsg);
        console.warn("âŒ Konum alÄ±namadÄ±:", error.message);
    }
    
    function showGpsError(message) {
        gpsErrorBox.style.display = 'block';
        gpsErrorMessage.textContent = message;
    }

    // YardÄ±mcÄ±: WhatsApp Link OluÅŸturucu
    function updateWhatsappUrl(text) {
        if(whatsappLink && phoneClean) {
            whatsappLink.href = `https://wa.me/${phoneClean}?text=${encodeURIComponent(text)}`;
        }
    }

    // YardÄ±mcÄ±: Harita BaÅŸlatÄ±cÄ±
    function initMap(lat, lng) {
        if (!map && mapContainer) {
            try {
                map = L.map('map-container', { zoomControl: false }).setView([lat, lng], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OSM'
                }).addTo(map);
                L.marker([lat, lng]).addTo(map).bindPopup('Sizin Konumunuz').openPopup();
            } catch (err) {
                console.error("Harita baÅŸlatma hatasÄ±:", err);
            }
        }
    }

    // YardÄ±mcÄ±: Sunucu KaydÄ±
    function saveToServer(lat, lng, acc, force = false, konumKaynagi = 'GPS') {
        // Accuracy kontrolÃ¼ (Ã§ok yanlÄ±ÅŸ konumlarÄ± gÃ¶nderme)
        if (!force && acc >= 5000) {
            console.warn("âš ï¸ Accuracy Ã§ok dÃ¼ÅŸÃ¼k (" + acc + "m), gÃ¶nderilmedi. force=true ile zorla gÃ¶nderebilirsiniz.");
            return;
        }

        if (gpsSent && !force) {
            console.log("âš ï¸ GPS zaten gÃ¶nderildi, tekrar gÃ¶nderilmiyor");
            return;
        }

        if (!taramaId) {
            console.warn("âš ï¸ tarama_id yok, GPS gÃ¶nderilemedi");
            return;
    }

        const formData = new URLSearchParams();
        formData.append('action', 'update_gps');
        formData.append('tarama_id', taramaId);
        formData.append('gps_latitude', lat.toString());
        formData.append('gps_longitude', lng.toString());
        formData.append('gps_accuracy', acc.toString());
        formData.append('konum_kaynagi', konumKaynagi);

        fetch(window.location.href, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                gpsSent = true;
                console.log("âœ… GPS baÅŸarÄ±yla gÃ¶nderildi:", data);
                // BaÅŸarÄ± mesajÄ±nÄ± gÃ¼ncelle
                const locationMessage = document.getElementById('location-message');
                if (locationMessage) {
                    locationMessage.textContent = `Konumunuz tespit edildi ve sahibe iletildi. (DoÄŸruluk: Â±${Math.round(acc)}m)`;
                    const locationAlert = document.getElementById('location-alert');
                    if (locationAlert) {
                        locationAlert.className = 'alert alert-success py-2 px-3 rounded-3 d-flex align-items-center';
                    }
                }
            } else {
                throw new Error(data.error || 'GPS gÃ¶nderilemedi');
            }
        })
        .catch(err => {
            console.error("âŒ GPS gÃ¶nderme hatasÄ±:", err);
            showGpsError('Konum gÃ¶nderilirken bir hata oluÅŸtu. LÃ¼tfen sayfayÄ± yenileyip tekrar deneyin.');
        });
    }
    
    // Manuel konum giriÅŸi
    const manualLocationBtn = document.getElementById('manual-location-btn');
    if (manualLocationBtn) {
        manualLocationBtn.addEventListener('click', function() {
            // Google Maps'te konum seÃ§me linki
            const currentLat = map ? map.getCenter().lat : '';
            const currentLng = map ? map.getCenter().lng : '';
            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${currentLat},${currentLng}`;
            
            // KullanÄ±cÄ±ya talimat ver
            const userInput = prompt(
                'Manuel konum giriÅŸi iÃ§in:\n\n' +
                '1. AÅŸaÄŸÄ±daki linke tÄ±klayÄ±n ve Google Maps\'te doÄŸru konumunuzu bulun\n' +
                '2. Konumunuzun koordinatlarÄ±nÄ± kopyalayÄ±n (Ã¶rnek: 41.0082, 28.9784)\n' +
                '3. Buraya yapÄ±ÅŸtÄ±rÄ±n\n\n' +
                'Link: ' + mapsUrl + '\n\n' +
                'KoordinatlarÄ± girin (lat, lng formatÄ±nda):'
            );
            
            if (userInput) {
                const coords = userInput.trim().split(',');
                if (coords.length === 2) {
                    const manualLat = parseFloat(coords[0].trim());
                    const manualLng = parseFloat(coords[1].trim());
                    
                    if (!isNaN(manualLat) && !isNaN(manualLng) &&
                        manualLat >= -90 && manualLat <= 90 &&
                        manualLng >= -180 && manualLng <= 180) {
                        
                        // HaritayÄ± gÃ¼ncelle
                        if (map) {
                            map.setView([manualLat, manualLng], 15);
                            map.eachLayer(function(layer) {
                                if (layer instanceof L.Marker) {
                                    map.removeLayer(layer);
                                }
                            });
                            L.marker([manualLat, manualLng]).addTo(map).bindPopup('Manuel Konumunuz').openPopup();
                        }
                        
                        // WhatsApp linkini gÃ¼ncelle
                        if (phoneClean) {
                            const mapsLink = `https://www.google.com/maps?q=${manualLat},${manualLng}`;
                            const locationMsg = `Merhaba, ${petName} isimli evcil hayvanÄ±nÄ±zÄ± buldum.\n\nğŸ“ Manuel olarak belirlediÄŸim konumum:\n${mapsLink}`;
                            updateWhatsappUrl(locationMsg);
                        }
                        
                        // Sunucuya gÃ¶nder (manuel konum, accuracy=50m olarak iÅŸaretle, konum_kaynagi=MANUEL)
                        saveToServer(manualLat, manualLng, 50, true, 'MANUEL');
                        
                        // MesajÄ± gÃ¼ncelle
                        const locationMessage = document.getElementById('location-message');
                        const locationAlert = document.getElementById('location-alert');
                        if (locationMessage) {
                            locationMessage.textContent = 'Manuel konumunuz kaydedildi ve sahibe iletildi.';
                        }
                        if (locationAlert) {
                            locationAlert.className = 'alert alert-success py-2 px-3 rounded-3 d-flex align-items-center';
                        }
                        if (locationWarning) {
                            locationWarning.style.display = 'none';
                        }
                        manualLocationBtn.style.display = 'none';
                    } else {
                        alert('GeÃ§ersiz koordinat formatÄ±. LÃ¼tfen "lat, lng" formatÄ±nda girin (Ã¶rnek: 41.0082, 28.9784)');
                    }
                } else {
                    alert('GeÃ§ersiz format. LÃ¼tfen "lat, lng" formatÄ±nda girin (Ã¶rnek: 41.0082, 28.9784)');
                }
            }
        });
    }
    
    // Butonlara basÄ±lÄ±nca (EÄŸer GPS henÃ¼z gelmediyse) manuel tetikle
    document.querySelectorAll('.contact-trigger').forEach(btn => {
        btn.addEventListener('click', function() {
            if (!map && navigator.geolocation && !gpsSent) {
                gpsLoadingBox.style.display = 'block';
                gpsErrorBox.style.display = 'none';
                navigator.geolocation.getCurrentPosition(onSuccess, onError, {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                });
            }
        });
    });
    
    // Form gÃ¶nderimi
    const bulanBilgiForm = document.getElementById('bulan-bilgi-form');
    const formLoading = document.getElementById('form-loading');
    const formSuccess = document.getElementById('form-success');
    const formError = document.getElementById('form-error');
    const formErrorMessage = document.getElementById('form-error-message');
    const submitBtn = document.getElementById('submit-btn');
    
    if (bulanBilgiForm) {
        bulanBilgiForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Form validasyonu
            const bulanIsim = this.querySelector('[name="bulan_isim"]').value.trim();
            const bulanTelefon = this.querySelector('[name="bulan_telefon"]').value.trim();
            const bulanMesaj = this.querySelector('[name="bulan_mesaj"]').value.trim();
            
            if (!bulanIsim || !bulanTelefon || !bulanMesaj) {
                showFormError('LÃ¼tfen tÃ¼m zorunlu alanlarÄ± doldurun.');
                return;
            }
            
            // Telefon format kontrolÃ¼ (basit)
            const phoneRegex = /^(\+90|0)?[5][0-9]{9}$/;
            const phoneClean = bulanTelefon.replace(/\D/g, '');
            if (!phoneRegex.test(phoneClean)) {
                showFormError('LÃ¼tfen geÃ§erli bir telefon numarasÄ± girin. (05XX XXX XX XX)');
                return;
            }
            
            // Loading state
            formLoading.style.display = 'block';
            formSuccess.style.display = 'none';
            formError.style.display = 'none';
            submitBtn.disabled = true;
            
            // GPS koordinatlarÄ±nÄ± al (varsa)
            const gpsLat = map ? map.getCenter().lat : '';
            const gpsLng = map ? map.getCenter().lng : '';
            const gpsAcc = map ? 50 : ''; // VarsayÄ±lan doÄŸruluk
            
            // Form verilerini hazÄ±rla
            const formData = new FormData(this);
            if (gpsLat && gpsLng) {
                formData.append('gps_latitude', gpsLat);
                formData.append('gps_longitude', gpsLng);
                if (gpsAcc) {
                    formData.append('gps_accuracy', gpsAcc);
                }
            }
            
            // GÃ¶nder
            fetch(window.location.href, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                formLoading.style.display = 'none';
                if (data.success) {
                    formSuccess.style.display = 'block';
                    this.reset();
                    // 3 saniye sonra mesajÄ± gizle
                    setTimeout(() => {
                        formSuccess.style.display = 'none';
                    }, 5000);
                } else {
                    throw new Error(data.error || 'Form gÃ¶nderilemedi');
                }
            })
            .catch(err => {
                formLoading.style.display = 'none';
                showFormError('Mesaj gÃ¶nderilirken bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.');
                console.error("Form gÃ¶nderme hatasÄ±:", err);
            })
            .finally(() => {
                submitBtn.disabled = false;
            });
        });
    }
    
    function showFormError(message) {
        formError.style.display = 'block';
        formErrorMessage.textContent = message;
        setTimeout(() => {
            formError.style.display = 'none';
        }, 5000);
    }
});
</script>
{% endblock %}