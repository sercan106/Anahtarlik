{% extends "ana.html" %}
{% load static %}

{% block title %}Profil Tamamla - Veteriner - PetSafe Hub{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">ğŸ¥ Veteriner Profili Tamamla</h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <strong>â„¹ï¸ Bilgilendirme:</strong> Veteriner panelinizi kullanabilmek iÃ§in aÅŸaÄŸÄ±daki bilgileri doldurmanÄ±z gerekmektedir.
                    </div>

                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <form method="post" id="profilForm">
                        {% csrf_token %}
                        
                        <div class="form-group">
                            <label for="id_ad">
                                <strong>Ad / Ä°ÅŸletme AdÄ± <span class="text-danger">*</span></strong>
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="id_ad" 
                                   name="ad" 
                                   value="{{ vet.ad }}"
                                   required>
                            <small class="form-text text-muted">Veteriner adÄ±nÄ±z veya klinik adÄ±nÄ±z</small>
                        </div>

                        <div class="form-group">
                            <label for="id_telefon">
                                <strong>Telefon</strong>
                            </label>
                            <input type="text" 
                                   class="form-control" 
                                   id="id_telefon" 
                                   name="telefon" 
                                   value="{{ vet.telefon }}"
                                   placeholder="0555 123 45 67">
                            <small class="form-text text-muted">Ä°letiÅŸim iÃ§in telefon numaranÄ±z</small>
                        </div>

                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="id_il">
                                    <strong>Ä°l <span class="text-danger">*</span></strong>
                                </label>
                                <select class="form-control" id="id_il" name="il" required>
                                    <option value="">Ä°l SeÃ§iniz</option>
                                    {% for il in iller %}
                                        <option value="{{ il.id }}" {% if vet.il and vet.il.id == il.id %}selected{% endif %}>
                                            {{ il.ad }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="form-group col-md-6">
                                <label for="id_ilce">
                                    <strong>Ä°lÃ§e <span class="text-danger">*</span></strong>
                                </label>
                                <select class="form-control" id="id_ilce" name="ilce" required>
                                    <option value="">Ä°lÃ§e SeÃ§iniz</option>
                                    {% for ilce in ilceler %}
                                        <option value="{{ ilce.id }}" {% if vet.ilce and vet.ilce.id == ilce.id %}selected{% endif %}>
                                            {{ ilce.ad }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="id_adres_detay">
                                <strong>Adres DetayÄ± <span class="text-danger">*</span></strong>
                            </label>
                            <textarea class="form-control" 
                                      id="id_adres_detay" 
                                      name="adres_detay" 
                                      rows="3" 
                                      required
                                      placeholder="Mahalle, sokak, bina no vb.">{{ vet.adres_detay }}</textarea>
                            <small class="form-text text-muted">DetaylÄ± adres bilgileriniz</small>
                        </div>

                        <div class="form-group mt-4">
                            <button type="submit" class="btn btn-primary btn-lg btn-block">
                                âœ… Profili Tamamla ve Panele Git
                            </button>
                        </div>

                        <div class="text-center mt-3">
                            <a href="{% url 'user_logout' %}" class="btn btn-link text-danger">
                                Ã‡Ä±kÄ±ÅŸ Yap
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Ä°l-Ä°lÃ§e dinamik yÃ¼kleme
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ”§ Veteriner profil tamamlama - Ä°l-Ä°lÃ§e dinamik yÃ¼kleme baÅŸlatÄ±lÄ±yor...');
    
    const ilField = document.getElementById('id_il');
    const ilceField = document.getElementById('id_ilce');
    
    if (!ilField || !ilceField) {
        console.warn('âš ï¸ Ä°l veya Ä°lÃ§e field bulunamadÄ±');
        return;
    }
    
    console.log('âœ… Ä°l ve Ä°lÃ§e field bulundu');
    
    // Ä°lÃ§e yÃ¼kleme fonksiyonu
    function loadDistricts(ilId, preserveSelected = false) {
        console.log('ğŸ”„ Ä°lÃ§eler yÃ¼kleniyor:', ilId);
        
        // Mevcut seÃ§ili deÄŸeri sakla
        const currentSelectedValue = preserveSelected ? ilceField.value : null;
        
        // Ä°lÃ§e alanÄ±nÄ± temizle
        ilceField.innerHTML = '<option value="">Ä°lÃ§e SeÃ§iniz</option>';
        
        if (!ilId) {
            console.log('âŒ Ä°l ID yok');
            return;
        }
        
        // Loading gÃ¶ster
        ilceField.disabled = true;
        const loadingOption = document.createElement('option');
        loadingOption.value = '';
        loadingOption.textContent = 'YÃ¼kleniyor...';
        ilceField.appendChild(loadingOption);
        
        // Fetch API ile ilÃ§e listesini getir
        fetch('/api/districts/?il_id=' + ilId, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin'
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('âœ… API yanÄ±tÄ±:', data);
                
                // Ä°lÃ§e alanÄ±nÄ± temizle
                ilceField.innerHTML = '<option value="">Ä°lÃ§e SeÃ§iniz</option>';
                
                // Ä°lÃ§eleri ekle
                if (Array.isArray(data) && data.length > 0) {
                    data.forEach(function(district) {
                        const option = document.createElement('option');
                        option.value = district.id;
                        option.textContent = district.ad;
                        
                        // Ã–nceden seÃ§ili deÄŸeri koru
                        if (preserveSelected && currentSelectedValue && district.id == currentSelectedValue) {
                            option.selected = true;
                        }
                        
                        ilceField.appendChild(option);
                    });
                    console.log('âœ… ' + data.length + ' ilÃ§e yÃ¼klendi');
                } else {
                    console.warn('âš ï¸ Ä°lÃ§e bulunamadÄ±');
                    const noDataOption = document.createElement('option');
                    noDataOption.value = '';
                    noDataOption.textContent = 'Ä°lÃ§e bulunamadÄ±';
                    ilceField.appendChild(noDataOption);
                }
                
                // Enable field
                ilceField.disabled = false;
            })
            .catch(error => {
                console.error('âŒ Ä°lÃ§e listesi yÃ¼klenirken hata:', error);
                ilceField.innerHTML = '<option value="">Hata: Ä°lÃ§eler yÃ¼klenemedi</option>';
                ilceField.disabled = false;
            });
    }
    
    // Ä°l deÄŸiÅŸtiÄŸinde ilÃ§e listesini gÃ¼ncelle
    ilField.addEventListener('change', function() {
        console.log('ğŸ”„ Ä°l deÄŸiÅŸti:', this.value);
        loadDistricts(this.value);
    });
    
    // Sayfa ilk yÃ¼klendiÄŸinde, eÄŸer il seÃ§ili ise ilÃ§e listesini yÃ¼kle
    if (ilField.value) {
        console.log('ğŸ”„ Ä°lk yÃ¼kleme - Ä°l seÃ§ili:', ilField.value);
        // KÃ¼Ã§Ã¼k bir gecikme ile tetikle (DOM'un tamamen hazÄ±r olmasÄ± iÃ§in)
        setTimeout(function() {
            loadDistricts(ilField.value, true); // Mevcut seÃ§ili ilÃ§eyi koru
        }, 100);
    }
    
    console.log('âœ… Veteriner profil tamamlama - Ä°l-Ä°lÃ§e dinamik yÃ¼kleme hazÄ±r');
});
</script>
{% endblock %}

