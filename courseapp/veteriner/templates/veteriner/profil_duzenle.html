{% extends "ana.html" %}
{% load static %}

{% block title %}Profil D√ºzenle - Veteriner - PetSafe Hub{% endblock %}

{% block css_dosyalar %}
<style>
    :root {
        --edit-primary: #5B9BD5;
        --edit-secondary: #70C1B3;
        --edit-accent: #FF8C42;
        --edit-success: #6FCF97;
    }

    .edit-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(25px);
        -webkit-backdrop-filter: blur(25px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 28px;
        box-shadow: 0 15px 45px rgba(91, 155, 213, 0.12);
        overflow: hidden;
    }

    .edit-header {
        background: linear-gradient(135deg, #5B9BD5 0%, #70C1B3 100%);
        color: white;
        padding: 2rem;
        border-radius: 28px 28px 0 0;
    }

    .form-control, .form-select {
        border: 2px solid rgba(91, 155, 213, 0.15);
        border-radius: 15px;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--edit-primary);
        box-shadow: 0 0 0 0.2rem rgba(91, 155, 213, 0.15);
    }

    .form-label {
        font-weight: 600;
        color: var(--edit-primary);
        margin-bottom: 0.5rem;
    }

    .btn-edit-primary {
        background: linear-gradient(135deg, #5B9BD5 0%, #70C1B3 100%);
        border: none;
        border-radius: 15px;
        color: white;
        padding: 0.75rem 2rem;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 8px 20px rgba(91, 155, 213, 0.25);
    }

    .btn-edit-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 30px rgba(91, 155, 213, 0.35);
        color: white;
    }

    .alert-info-custom {
        background: linear-gradient(135deg, rgba(91, 155, 213, 0.1) 0%, rgba(112, 193, 179, 0.1) 100%);
        border-left: 5px solid var(--edit-primary);
        border-radius: 15px;
        padding: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="edit-card">
                <div class="edit-header">
                    <h4 class="mb-0 fw-bold"><i class="fas fa-user-edit me-2"></i>Veteriner Profili D√ºzenle</h4>
                </div>
                <div class="p-4">
                    <div class="alert-info-custom mb-4">
                        <strong><i class="fas fa-info-circle me-2"></i>Bilgilendirme:</strong> Temel profil bilgilerinizi buradan g√ºncelleyebilirsiniz. Web sayfanƒ±zƒ± d√ºzenlemek i√ßin <a href="{% url 'veteriner:web_sayfasi_duzenle' %}" class="fw-bold" style="color: var(--edit-primary); text-decoration: none;">buraya tƒ±klayƒ±n</a>.
                    </div>

                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <form method="post" id="profilForm">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.ad.id_for_label }}" class="form-label">
                                    <strong>Ad / ƒ∞≈ületme Adƒ± <span class="text-danger">*</span></strong>
                                </label>
                                {{ form.ad }}
                                {% if form.ad.errors %}
                                    <div class="text-danger small">{{ form.ad.errors|first }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="{{ form.telefon.id_for_label }}" class="form-label">
                                    <strong>Telefon</strong>
                                </label>
                                {{ form.telefon }}
                                {% if form.telefon.errors %}
                                    <div class="text-danger small">{{ form.telefon.errors|first }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.email.id_for_label }}" class="form-label">
                                <strong>E-posta</strong>
                            </label>
                            {{ form.email }}
                            {% if form.email.errors %}
                                <div class="text-danger small">{{ form.email.errors|first }}</div>
                            {% endif %}
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="id_il" class="form-label">
                                    <strong>ƒ∞l <span class="text-danger">*</span></strong>
                                </label>
                                <select class="form-control" id="id_il" name="il" required>
                                    <option value="">ƒ∞l Se√ßiniz</option>
                                    {% for il in iller %}
                                        <option value="{{ il.id }}" {% if veteriner.il and veteriner.il.id == il.id %}selected{% endif %}>
                                            {{ il.ad }}
                                        </option>
                                    {% endfor %}
                                </select>
                                {% if form.il.errors %}
                                    <div class="text-danger small">{{ form.il.errors|first }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="id_ilce" class="form-label">
                                    <strong>ƒ∞l√ße <span class="text-danger">*</span></strong>
                                </label>
                                <select class="form-control" id="id_ilce" name="ilce" required>
                                    <option value="">ƒ∞l√ße Se√ßiniz</option>
                                    {% for ilce in ilceler %}
                                        <option value="{{ ilce.id }}" {% if veteriner.ilce and veteriner.ilce.id == ilce.id %}selected{% endif %}>
                                            {{ ilce.ad }}
                                        </option>
                                    {% endfor %}
                                </select>
                                {% if form.ilce.errors %}
                                    <div class="text-danger small">{{ form.ilce.errors|first }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="id_mahalle" class="form-label">
                                    <strong>Mahalle</strong>
                                </label>
                                <select class="form-control" id="id_mahalle" name="mahalle">
                                    <option value="">Mahalle Se√ßiniz</option>
                                    {% if veteriner.mahalle %}
                                        <option value="{{ veteriner.mahalle.id }}" selected>{{ veteriner.mahalle.ad }}</option>
                                    {% endif %}
                                </select>
                                {% if form.mahalle.errors %}
                                    <div class="text-danger small">{{ form.mahalle.errors|first }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="id_mahalle_diger" class="form-label">
                                    <strong>Mahalle (Manuel)</strong>
                                </label>
                                <input type="text" class="form-control" id="id_mahalle_diger" name="mahalle_diger"
                                       value="{{ veteriner.mahalle_diger|default:'' }}"
                                       placeholder="Mahalle listede yoksa buraya yazƒ±nƒ±z">
                                <small class="text-muted">Mahalle listede yoksa manuel girebilirsiniz</small>
                                {% if form.mahalle_diger.errors %}
                                    <div class="text-danger small">{{ form.mahalle_diger.errors|first }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.adres_detay.id_for_label }}" class="form-label">
                                <strong>Adres Detayƒ± <span class="text-danger">*</span></strong>
                            </label>
                            {{ form.adres_detay }}
                            {% if form.adres_detay.errors %}
                                <div class="text-danger small">{{ form.adres_detay.errors|first }}</div>
                            {% endif %}
                        </div>

                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}

                        <div class="d-grid gap-3 d-md-flex justify-content-md-between mt-4">
                            <a href="{% url 'veteriner:veteriner_paneli' %}" class="btn btn-edit-primary" style="background: linear-gradient(135deg, rgba(91, 155, 213, 0.8) 0%, rgba(112, 193, 179, 0.8) 100%);">
                                <i class="fas fa-arrow-left me-2"></i>Geri D√∂n
                            </a>
                            <button type="submit" class="btn btn-edit-primary px-5">
                                <i class="fas fa-save me-2"></i>Kaydet
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ƒ∞l-ƒ∞l√ße-Mahalle dinamik y√ºkleme
(function() {
    'use strict';

    // Sayfa y√ºklendiƒüinde √ßalƒ±≈ütƒ±r
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    function init() {
        console.log('Veteriner profil duzenleme - Il-Ilce-Mahalle dinamik yukleme baslat');

        const ilField = document.getElementById('id_il');
        const ilceField = document.getElementById('id_ilce');
        const mahalleField = document.getElementById('id_mahalle');

        if (!ilField || !ilceField || !mahalleField) {
            console.warn('Il, Ilce veya Mahalle field bulunamadi');
            return;
        }

        console.log('Il, Ilce ve Mahalle field bulundu');

        // Se√ßili il√ße ve mahalle'yi sakla (edit modunda)
        const initialIlceId = ilceField.value;
        const initialMahalleId = mahalleField.value;
        console.log('Baslangic ilce ID:', initialIlceId);
        console.log('Baslangic mahalle ID:', initialMahalleId);

        // ƒ∞l deƒüi≈ütiƒüinde il√ße listesini g√ºncelle
        ilField.addEventListener('change', function() {
            const ilId = this.value;
            console.log('Il degisti:', ilId);

            // ƒ∞l√ße ve mahalle alanƒ±nƒ± temizle
            ilceField.innerHTML = '<option value="">ƒ∞l√ße Se√ßiniz</option>';
            mahalleField.innerHTML = '<option value="">√ñnce il√ße se√ßiniz</option>';

            if (!ilId) {
                console.log('Il secilmedi');
                return;
            }
            
            // Loading g√∂ster
            ilceField.disabled = true;
            const loadingOption = document.createElement('option');
            loadingOption.value = '';
            loadingOption.textContent = 'Y√ºkleniyor...';
            ilceField.appendChild(loadingOption);
            
            console.log('üì° API isteƒüi g√∂nderiliyor:', '/api/districts/?il_id=' + ilId);
            
            // Fetch API ile il√ße listesini getir
            fetch('/api/districts/?il_id=' + ilId)
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('HTTP error! status: ' + response.status);
                    }
                    return response.json();
                })
                .then(function(data) {
                    console.log('‚úÖ API yanƒ±tƒ±:', data);
                    
                    // ƒ∞l√ße alanƒ±nƒ± temizle
                    ilceField.innerHTML = '<option value="">ƒ∞l√ße Se√ßiniz</option>';
                    
                    // ƒ∞l√ßeleri ekle
                    if (Array.isArray(data) && data.length > 0) {
                        data.forEach(function(district) {
                            const option = document.createElement('option');
                            option.value = district.id;
                            option.textContent = district.ad;
                            
                            // Edit modunda √∂nceden se√ßili olan il√ßeyi se√ß
                            if (initialIlceId && district.id == initialIlceId) {
                                option.selected = true;
                            }
                            
                            ilceField.appendChild(option);
                        });
                        console.log('‚úÖ ' + data.length + ' il√ße y√ºklendi');
                    } else {
                        console.warn('‚ö†Ô∏è ƒ∞l√ße bulunamadƒ±');
                        const noDataOption = document.createElement('option');
                        noDataOption.value = '';
                        noDataOption.textContent = 'ƒ∞l√ße bulunamadƒ±';
                        ilceField.appendChild(noDataOption);
                    }
                    
                    // Enable field
                    ilceField.disabled = false;
                })
                .catch(function(error) {
                    console.error('‚ùå ƒ∞l√ße listesi y√ºklenirken hata:', error);
                    
                    ilceField.innerHTML = '<option value="">Hata: ƒ∞l√ßeler y√ºklenemedi</option>';
                    ilceField.disabled = false;
                });
        });

        // ƒ∞l√ße deƒüi≈ütiƒüinde mahalle listesini g√ºncelle
        ilceField.addEventListener('change', function() {
            const ilceId = this.value;
            console.log('Ilce degisti:', ilceId);

            // Mahalle alanƒ±nƒ± temizle
            mahalleField.innerHTML = '<option value="">Mahalle Se√ßiniz</option>';

            if (!ilceId) {
                console.log('Ilce secilmedi');
                return;
            }

            // Loading g√∂ster
            mahalleField.disabled = true;
            const loadingOption = document.createElement('option');
            loadingOption.value = '';
            loadingOption.textContent = 'Yukleniyor...';
            mahalleField.appendChild(loadingOption);

            console.log('API istegi gonderiliyor:', '/ajax/get-mahalleler/?ilce_id=' + ilceId);

            // Fetch API ile mahalle listesini getir
            fetch('/ajax/get-mahalleler/?ilce_id=' + ilceId)
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('HTTP error! status: ' + response.status);
                    }
                    return response.json();
                })
                .then(function(data) {
                    console.log('API yaniti:', data);

                    // Mahalle alanƒ±nƒ± temizle
                    mahalleField.innerHTML = '<option value="">Mahalle Se√ßiniz</option>';

                    // Mahalleleri ekle
                    if (Array.isArray(data) && data.length > 0) {
                        data.forEach(function(mahalle) {
                            const option = document.createElement('option');
                            option.value = mahalle.id;
                            option.textContent = mahalle.ad;

                            // Edit modunda √∂nceden se√ßili olan mahalle'yi se√ß
                            if (initialMahalleId && mahalle.id == initialMahalleId) {
                                option.selected = true;
                            }

                            mahalleField.appendChild(option);
                        });
                        console.log(data.length + ' mahalle yuklendi');
                    } else {
                        console.warn('Mahalle bulunamadi');
                        const noDataOption = document.createElement('option');
                        noDataOption.value = '';
                        noDataOption.textContent = 'Mahalle bulunamadi';
                        mahalleField.appendChild(noDataOption);
                    }

                    // Enable field
                    mahalleField.disabled = false;
                })
                .catch(function(error) {
                    console.error('Mahalle listesi yuklenirken hata:', error);

                    mahalleField.innerHTML = '<option value="">Hata: Mahalleler yuklenemedi</option>';
                    mahalleField.disabled = false;
                });
        });

        // Sayfa ilk y√ºklendiƒüinde, eƒüer il se√ßili ise il√ße listesini y√ºkle
        if (ilField.value) {
            console.log('Ilk yukleme - Il secili:', ilField.value);
            // K√º√ß√ºk bir gecikme ile tetikle (DOM'un tamamen hazƒ±r olmasƒ± i√ßin)
            setTimeout(function() {
                const event = new Event('change');
                ilField.dispatchEvent(event);

                // Eƒüer il√ße de se√ßiliyse, mahalle listesini y√ºkle
                if (ilceField.value) {
                    setTimeout(function() {
                        const ilceEvent = new Event('change');
                        ilceField.dispatchEvent(ilceEvent);
                    }, 200);
                }
            }, 100);
        }

        console.log('Veteriner profil duzenleme - Il-Ilce-Mahalle dinamik yukleme hazir');
    }
})();
</script>
{% endblock %}

