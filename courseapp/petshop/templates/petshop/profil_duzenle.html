{% extends "ana.html" %}
{% load static %}

{% block title %}Profil D√ºzenle - PetShop - PetSafe Hub{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0"><i class="fas fa-user-edit me-2"></i>PetShop Profili D√ºzenle</h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <strong><i class="fas fa-info-circle me-1"></i> Bilgilendirme:</strong> Temel profil bilgilerinizi buradan g√ºncelleyebilirsiniz. Web sayfanƒ±zƒ± d√ºzenlemek i√ßin <a href="{% url 'petshop:web_sayfasi_duzenle' %}" class="alert-link">buraya tƒ±klayƒ±n</a>.
                    </div>

                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <form method="post" id="profilForm">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.ad.id_for_label }}" class="form-label">
                                    <strong>ƒ∞≈ületme Adƒ± <span class="text-danger">*</span></strong>
                                </label>
                                {{ form.ad }}
                                {% if form.ad.errors %}
                                    <div class="text-danger small">{{ form.ad.errors|first }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="{{ form.telefon.id_for_label }}" class="form-label">
                                    <strong>Telefon</strong>
                                </label>
                                {{ form.telefon }}
                                {% if form.telefon.errors %}
                                    <div class="text-danger small">{{ form.telefon.errors|first }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.email.id_for_label }}" class="form-label">
                                <strong>E-posta</strong>
                            </label>
                            {{ form.email }}
                            {% if form.email.errors %}
                                <div class="text-danger small">{{ form.email.errors|first }}</div>
                            {% endif %}
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="id_il" class="form-label">
                                    <strong>ƒ∞l <span class="text-danger">*</span></strong>
                                </label>
                                <select class="form-control" id="id_il" name="il" required>
                                    <option value="">ƒ∞l Se√ßiniz</option>
                                    {% for il in iller %}
                                        <option value="{{ il.id }}" {% if petshop.il and petshop.il.id == il.id %}selected{% endif %}>
                                            {{ il.ad }}
                                        </option>
                                    {% endfor %}
                                </select>
                                {% if form.il.errors %}
                                    <div class="text-danger small">{{ form.il.errors|first }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="id_ilce" class="form-label">
                                    <strong>ƒ∞l√ße <span class="text-danger">*</span></strong>
                                </label>
                                <select class="form-control" id="id_ilce" name="ilce" required>
                                    <option value="">ƒ∞l√ße Se√ßiniz</option>
                                    {% for ilce in ilceler %}
                                        <option value="{{ ilce.id }}" {% if petshop.ilce and petshop.ilce.id == ilce.id %}selected{% endif %}>
                                            {{ ilce.ad }}
                                        </option>
                                    {% endfor %}
                                </select>
                                {% if form.ilce.errors %}
                                    <div class="text-danger small">{{ form.ilce.errors|first }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="id_mahalle" class="form-label">
                                    <strong>Mahalle</strong>
                                </label>
                                <select class="form-control" id="id_mahalle" name="mahalle">
                                    <option value="">Mahalle Se√ßiniz</option>
                                    {% if petshop.mahalle %}
                                        <option value="{{ petshop.mahalle.id }}" selected>{{ petshop.mahalle.ad }}</option>
                                    {% endif %}
                                </select>
                                {% if form.mahalle.errors %}
                                    <div class="text-danger small">{{ form.mahalle.errors|first }}</div>
                                {% endif %}
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="id_mahalle_diger" class="form-label">
                                    <strong>Mahalle (Manuel)</strong>
                                </label>
                                <input type="text" class="form-control" id="id_mahalle_diger" name="mahalle_diger"
                                       value="{{ petshop.mahalle_diger|default:'' }}"
                                       placeholder="Mahalle listede yoksa buraya yazƒ±nƒ±z">
                                <small class="text-muted">Mahalle listede yoksa manuel girebilirsiniz</small>
                                {% if form.mahalle_diger.errors %}
                                    <div class="text-danger small">{{ form.mahalle_diger.errors|first }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.adres_detay.id_for_label }}" class="form-label">
                                <strong>Adres Detayƒ± <span class="text-danger">*</span></strong>
                            </label>
                            {{ form.adres_detay }}
                            {% if form.adres_detay.errors %}
                                <div class="text-danger small">{{ form.adres_detay.errors|first }}</div>
                            {% endif %}
                        </div>

                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}

                        <div class="d-grid gap-2 d-md-flex justify-content-md-between mt-4">
                            <a href="{% url 'petshop:petshop_paneli' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-1"></i> Geri D√∂n
                            </a>
                            <button type="submit" class="btn btn-success px-5">
                                <i class="fas fa-save me-1"></i> Kaydet
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ƒ∞l-ƒ∞l√ße-Mahalle dinamik y√ºkleme
(function() {
    'use strict';

    // Sayfa y√ºklendiƒüinde √ßalƒ±≈ütƒ±r
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    function init() {
        console.log('üîß PetShop profil d√ºzenleme - ƒ∞l-ƒ∞l√ße-Mahalle dinamik y√ºkleme ba≈ülatƒ±lƒ±yor...');

        const ilField = document.getElementById('id_il');
        const ilceField = document.getElementById('id_ilce');
        const mahalleField = document.getElementById('id_mahalle');

        if (!ilField || !ilceField || !mahalleField) {
            console.warn('‚ö†Ô∏è ƒ∞l, ƒ∞l√ße veya Mahalle field bulunamadƒ±');
            return;
        }

        console.log('‚úÖ ƒ∞l, ƒ∞l√ße ve Mahalle field bulundu');
        
        // Se√ßili il√ße ve mahalle'yi sakla (edit modunda)
        const initialIlceId = ilceField.value;
        const initialMahalleId = mahalleField.value;
        console.log('üìù Ba≈ülangƒ±√ß il√ße ID:', initialIlceId);
        console.log('üìù Ba≈ülangƒ±√ß mahalle ID:', initialMahalleId);

        // ƒ∞l deƒüi≈ütiƒüinde il√ße listesini g√ºncelle
        ilField.addEventListener('change', function() {
            const ilId = this.value;
            console.log('üîÑ ƒ∞l deƒüi≈üti:', ilId);

            // ƒ∞l√ße ve mahalle alanƒ±nƒ± temizle
            ilceField.innerHTML = '<option value="">ƒ∞l√ße Se√ßiniz</option>';
            mahalleField.innerHTML = '<option value="">√ñnce il√ße se√ßiniz</option>';

            if (!ilId) {
                console.log('‚ùå ƒ∞l se√ßilmedi');
                return;
            }
            
            // Loading g√∂ster
            ilceField.disabled = true;
            const loadingOption = document.createElement('option');
            loadingOption.value = '';
            loadingOption.textContent = 'Y√ºkleniyor...';
            ilceField.appendChild(loadingOption);
            
            console.log('üì° API isteƒüi g√∂nderiliyor:', '/api/districts/?il_id=' + ilId);
            
            // Fetch API ile il√ße listesini getir
            fetch('/api/districts/?il_id=' + ilId)
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('HTTP error! status: ' + response.status);
                    }
                    return response.json();
                })
                .then(function(data) {
                    console.log('‚úÖ API yanƒ±tƒ±:', data);
                    
                    // ƒ∞l√ße alanƒ±nƒ± temizle
                    ilceField.innerHTML = '<option value="">ƒ∞l√ße Se√ßiniz</option>';
                    
                    // ƒ∞l√ßeleri ekle
                    if (Array.isArray(data) && data.length > 0) {
                        data.forEach(function(district) {
                            const option = document.createElement('option');
                            option.value = district.id;
                            option.textContent = district.ad;
                            
                            // Edit modunda √∂nceden se√ßili olan il√ßeyi se√ß
                            if (initialIlceId && district.id == initialIlceId) {
                                option.selected = true;
                            }
                            
                            ilceField.appendChild(option);
                        });
                        console.log('‚úÖ ' + data.length + ' il√ße y√ºklendi');
                    } else {
                        console.warn('‚ö†Ô∏è ƒ∞l√ße bulunamadƒ±');
                        const noDataOption = document.createElement('option');
                        noDataOption.value = '';
                        noDataOption.textContent = 'ƒ∞l√ße bulunamadƒ±';
                        ilceField.appendChild(noDataOption);
                    }
                    
                    // Enable field
                    ilceField.disabled = false;
                })
                .catch(function(error) {
                    console.error('‚ùå ƒ∞l√ße listesi y√ºklenirken hata:', error);
                    
                    ilceField.innerHTML = '<option value="">Hata: ƒ∞l√ßeler y√ºklenemedi</option>';
                    ilceField.disabled = false;
                });
        });

        // ƒ∞l√ße deƒüi≈ütiƒüinde mahalle listesini g√ºncelle
        ilceField.addEventListener('change', function() {
            const ilceId = this.value;
            console.log('üîÑ ƒ∞l√ße deƒüi≈üti:', ilceId);

            // Mahalle alanƒ±nƒ± temizle
            mahalleField.innerHTML = '<option value="">Mahalle Se√ßiniz</option>';

            if (!ilceId) {
                console.log('‚ùå ƒ∞l√ße se√ßilmedi');
                return;
            }

            // Loading g√∂ster
            mahalleField.disabled = true;
            const loadingOption = document.createElement('option');
            loadingOption.value = '';
            loadingOption.textContent = 'Y√ºkleniyor...';
            mahalleField.appendChild(loadingOption);

            console.log('üì° API isteƒüi g√∂nderiliyor:', '/ajax/get-mahalleler/?ilce_id=' + ilceId);

            // Fetch API ile mahalle listesini getir
            fetch('/ajax/get-mahalleler/?ilce_id=' + ilceId)
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('HTTP error! status: ' + response.status);
                    }
                    return response.json();
                })
                .then(function(data) {
                    console.log('‚úÖ API yanƒ±tƒ±:', data);

                    // Mahalle alanƒ±nƒ± temizle
                    mahalleField.innerHTML = '<option value="">Mahalle Se√ßiniz</option>';

                    // Mahalleleri ekle
                    if (Array.isArray(data) && data.length > 0) {
                        data.forEach(function(mahalle) {
                            const option = document.createElement('option');
                            option.value = mahalle.id;
                            option.textContent = mahalle.ad;

                            // Edit modunda √∂nceden se√ßili olan mahalle'yi se√ß
                            if (initialMahalleId && mahalle.id == initialMahalleId) {
                                option.selected = true;
                            }

                            mahalleField.appendChild(option);
                        });
                        console.log('‚úÖ ' + data.length + ' mahalle y√ºklendi');
                    } else {
                        console.warn('‚ö†Ô∏è Mahalle bulunamadƒ±');
                        const noDataOption = document.createElement('option');
                        noDataOption.value = '';
                        noDataOption.textContent = 'Mahalle bulunamadƒ±';
                        mahalleField.appendChild(noDataOption);
                    }

                    // Enable field
                    mahalleField.disabled = false;
                })
                .catch(function(error) {
                    console.error('‚ùå Mahalle listesi y√ºklenirken hata:', error);

                    mahalleField.innerHTML = '<option value="">Hata: Mahalleler y√ºklenemedi</option>';
                    mahalleField.disabled = false;
                });
        });

        // Sayfa ilk y√ºklendiƒüinde, eƒüer il se√ßili ise il√ße listesini y√ºkle
        if (ilField.value) {
            console.log('üîÑ ƒ∞lk y√ºkleme - ƒ∞l se√ßili:', ilField.value);
            // K√º√ß√ºk bir gecikme ile tetikle (DOM'un tamamen hazƒ±r olmasƒ± i√ßin)
            setTimeout(function() {
                const event = new Event('change');
                ilField.dispatchEvent(event);

                // Eƒüer il√ße de se√ßiliyse, mahalle listesini y√ºkle
                if (ilceField.value) {
                    setTimeout(function() {
                        const ilceEvent = new Event('change');
                        ilceField.dispatchEvent(ilceEvent);
                    }, 200);
                }
            }, 100);
        }

        console.log('‚úÖ PetShop profil d√ºzenleme - ƒ∞l-ƒ∞l√ße-Mahalle dinamik y√ºkleme hazƒ±r');
    }
})();
</script>
{% endblock %}

